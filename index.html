<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tiles Wars</title>
  <!-- Caricamento librerie esterne (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.2.4/pixi.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <!-- CSS dist -->
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- ================= SETUP MENU ================== -->
  <div id="menu">
    <div class="menu-card">
      <div class="menu-header">
        <h1>Chain Reaction</h1>
        <p class="subtitle">Setup partita ‚Ä¢ Scegli le impostazioni e inizia</p>
      </div>

      <div class="menu-grid">
        <div class="form-group group-players">
          <div class="group-title">Players</div>
          <div class="form-row">
            <label for="playerSelect">Number of players (2..10)</label>
            <input type="number" id="playerSelect" min="2" max="10" value="4">
          </div>
          <div class="form-row">
            <label for="aiPlayerSelect">AI Players</label>
            <select id="aiPlayerSelect">
              <!-- Options popolati da JS -->
            </select>
          </div>
        </div>

        <div class="form-group group-grid">
          <div class="group-title">Grid</div>
          <div class="form-row">
            <label for="widthSelect">Grid Width</label>
            <input type="number" id="widthSelect" min="4" max="50" value="11">
          </div>
          <div class="form-row">
            <label for="heightSelect">Grid Height</label>
            <input type="number" id="heightSelect" min="4" max="50" value="11">
          </div>
          <div class="form-row">
            <label for="rockCellInput">Number of Rock Cells</label>
            <input type="number" id="rockCellInput" min="0" value="0">
          </div>
        </div>

        <div class="form-group group-timers">
          <div class="group-title">Timers</div>
          <div class="form-row">
            <label for="turnTimerInput">Turn Timer (seconds)</label>
            <input type="number" id="turnTimerInput" min="5" max="60" value="30">
          </div>
          <div class="form-row">
            <label for="suddenDeathTimerInput">Sudden Death Timer (seconds)</label>
            <input type="number" id="suddenDeathTimerInput" min="10" max="300" value="60">
          </div>
          <label class="checkbox-row">
            <input type="checkbox" id="suddenDeathToggle">
            Enable Sudden Death Timer
          </label>
        </div>

        <div class="form-group group-options">
          <div class="group-title">Options</div>
          <div class="form-row">
            <label for="setupSelect">Initial Setup</label>
            <select id="setupSelect">
              <option value="auto" selected>Automatic</option>
              <option value="manual">Manual</option>
              <option value="geometric">Geometric</option>
              <option value="geometric2">Geometric 2</option>
            </select>
          </div>
          <div id="setupPreview" class="preset-preview" aria-live="polite"></div>
          <label class="checkbox-row">
            <input type="checkbox" id="preformToggle">
            Enable formations
          </label>
          <div class="form-row">
            <label for="initValueSelect">Initial Tile Value</label>
            <select id="initValueSelect">
              <option value="1" selected>1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4 (explodes immediately!)</option>
            </select>
          </div>
          <label class="checkbox-row">
            <input type="checkbox" id="toggleNumbers">
            Show numbers on tiles
          </label>
          <label class="checkbox-row">
            <input type="checkbox" id="showDefeatPopupToggle" checked>
            Show defeat popup
          </label>
          <label class="checkbox-row">
            <input type="checkbox" id="newsToggle" checked>
            Enable Tiles Wars News
          </label>
          <label class="checkbox-row">
            <input type="checkbox" id="tilesOfWarToggle">
            Enable Tiles of War (powerups)
          </label>
          <div id="powerupOptions" class="powerup-options" aria-hidden="true">
            <label class="checkbox-row">
              <input type="checkbox" id="powerupRomboidToggle" checked>
              Enable Romboid
            </label>
            <label class="checkbox-row">
              <input type="checkbox" id="powerupViewfinderToggle" checked>
              Enable Viewfinder
            </label>
            <label class="checkbox-row">
              <input type="checkbox" id="powerupWallToggle" checked>
              Enable Wall
            </label>
            <label class="checkbox-row">
              <input type="checkbox" id="powerupSkipToggle" checked>
              Enable Skip Turn
            </label>
          </div>
          <div class="form-row">
            <label for="powerupCooldownInput">Powerup cooldown (turns per player)</label>
            <input type="number" id="powerupCooldownInput" min="0" max="10" value="2" style="max-width:120px"/>
          </div>
          <div class="form-row">
            <label for="powerupCooldownMode">Cooldown applies to</label>
            <select id="powerupCooldownMode">
              <option value="block" selected>Whole powerup bar</option>
              <option value="perPower">Individual powerups</option>
            </select>
          </div>
          <div class="form-row">
            <label for="specialTilesToggle">Special Tiles (every X turns)</label>
            <input type="checkbox" id="specialTilesToggle">
            <input type="number" id="specialTilesInterval" min="1" value="5" style="max-width:120px"/>
          </div>
          <div class="form-row">
            <label for="specialTilesDuration">Special lasts (Y rounds)</label>
            <input type="number" id="specialTilesDuration" min="1" value="3" style="max-width:120px"/>
          </div>
          <div class="form-row">
            <label for="scoreTargetInput">Score to win (special mode)</label>
            <input type="number" id="scoreTargetInput" min="10" max="500" value="100" style="max-width:140px"/>
          </div>
          <div class="form-row">
            <label for="powerupCostMode">Powerup payment</label>
            <select id="powerupCostMode">
              <option value="tile" selected>Sacrifice tile</option>
              <option value="points">Pay points</option>
              <option value="either">Tile or points</option>
              <option value="formations">Formations</option>
            </select>
            <input type="number" id="powerupPointCost" min="0" max="200" value="20" style="max-width:120px" title="Points cost if paying with points"/>
          </div>
        </div>

        <div class="form-group group-endgame">
          <div class="group-title">Endgame</div>
          <div class="form-row">
            <label for="roundsPerRingInput">Rounds per shrink (1..50)</label>
            <input type="number" id="roundsPerRingInput" min="1" max="50" value="6">
          </div>
          <div class="form-row">
            <label for="shrinkCoverageToggle">Delay shrink until board coverage (%)</label>
            <input type="checkbox" id="shrinkCoverageToggle">
            <input type="number" id="shrinkCoverageInput" min="10" max="100" value="75" style="max-width:120px">
          </div>
          <label class="checkbox-row">
            <input type="checkbox" id="shrinkEnabledToggle" checked>
            Enable Shrinking Rings
          </label>
          <div class="form-row">
            <label for="shrinkAnimSelect">Shrink animation</label>
            <select id="shrinkAnimSelect">
              <option value="fall">Falling Blocks</option>
              <option value="walls">Closing Walls</option>
              <option value="falloff" selected>Falling Edge (platform)</option>
            </select>
            <button id="previewShrinkAnimBtn" type="button">Preview</button>
          </div>
          <label class="checkbox-row">
            <input type="checkbox" id="showShrinkCounterToggle">
            Show shrink counter during match
          </label>
        </div>

        <!-- MOVED: Multiplayer block inside grid -->
        <div class="menu-network group-network">
          <div class="group-title">Multiplayer (local test)</div>
          <div class="form-row" id="netPlayerCountRow" style="display:flex;">
            <label>Players in room</label>
            <span id="netPlayerCount" style="font-weight:700;">0</span>
            <button type="button" id="syncStateBtn" style="display:none; margin-left:auto; font-size:11px; padding:2px 6px;">Sync State</button>
          </div>
          <div class="form-row">
            <label>Mode</label>
            <button type="button" id="netModeToggle" style="min-width: 140px;">Local (offline)</button>
          </div>
          <div class="form-row" id="netAiRow" style="display:flex; align-items:center; gap:10px;">
            <label>Add AI Players</label>
            <div style="display:flex; align-items:center; gap:8px;">
              <button type="button" id="decAiBtn" style="padding:2px 8px;">-</button>
              <span id="multiAiCount" style="font-weight:700; min-width:12px; text-align:center;">0</span>
              <button type="button" id="incAiBtn" style="padding:2px 8px;">+</button>
            </div>
          </div>
          <div class="form-row" id="netButtons" style="display:flex; gap:6px; flex-wrap:wrap;">
            <button type="button" id="createRoomBtn">Create room</button>
            <button type="button" id="joinRoomBtn">Join room</button>
            <input type="text" id="roomCodeInput" placeholder="ROOMCODE" style="max-width:140px; text-transform:uppercase;"/>
          </div>
          <div class="form-row" id="netStatusRow" style="display:flex; font-weight:600; color:#1f2937;">
            <label>Status</label>
            <button type="button" id="netStatus" style="border:none; background:none; padding:0; cursor:pointer; color:#1d4ed8;">Offline</button>
          </div>
          <p class="hint">Host creates a room, others join with the code. Works only via local WS relay (node server.js).</p>
        </div>
      </div>

      <div class="menu-actions">
        <button id="startBtn" class="primary">Start Game</button>
        <button id="presetStandardBtn" type="button" style="margin-left:8px;">Preset 10x10 ‚Ä¢ 4P (3 AI) ‚Ä¢ Shrink 10</button>
        <button id="presetChaos2PBtn" type="button" style="margin-left:8px;">Chaos Preset ‚Ä¢ 50% Filled ‚Ä¢ Shrink 3</button>
        <button id="presetDebugBtn" type="button" style="margin-left:8px;">Preset Debug ‚Ä¢ 10x10 ‚Ä¢ 4P (3 AI) ‚Ä¢ Shrink 3</button>
        <button id="presetQuadrantSeedBtn" type="button" style="margin-left:8px;">Preset Test 10x10 ‚Ä¢ 4P Quadrants Seed</button>
        <div id="presetPreview" class="preset-preview" aria-live="polite"></div>
      </div>
    </div>
  </div>

  <!-- ================== GAME CONTAINER ================== -->
  <div id="game-container">
    <div id="powerupBar" aria-hidden="true">
      <button class="powerup-btn" id="powerupRomboid" disabled>‚¨¶ Romboid</button>
      <button class="powerup-btn" id="powerupViewfinder" disabled>üéØ Viewfinder</button>
      <button class="powerup-btn" id="powerupWall" disabled>üß± Wall</button>
      <button class="powerup-btn" id="powerupSkip" disabled>‚è≠ Skip</button>
      <div class="powerup-cooldown" id="powerupCooldownHint"></div>
    </div>
    <!-- ================== TIMER DISPLAY ================== -->
    <div id="timerDisplay">
      <div class="timer-main">
        <span id="turnTimerDisplay" class="player-timer">Turn Timer: 0s</span>
        <span id="suddenDeathTimerDisplay" class="timer-detail">Sudden Death Timer: 0s</span>
        <span id="shrinkCounterDisplay" class="timer-detail">Shrink in: 0 rounds</span>
      </div>
      <div id="shrinkCoverageBuffer" class="shrink-buffer" aria-hidden="true">
        <div id="shrinkCoverageLabel" class="shrink-buffer-label">Shrink gate: 0%</div>
        <div class="shrink-buffer-track">
          <div id="shrinkCoverageFill" class="shrink-buffer-fill"></div>
        </div>
      </div>
    </div>
    <div id="pixiContainer"></div>
    <div id="preformMenu" aria-hidden="true">
      <div class="preform-header">
        <span id="preformTitle">Formations</span>
      </div>
      <div class="preform-controls">
        <button id="preformPrevBtn" type="button">‚óÄ</button>
        <div id="preformPreview" class="preform-preview"></div>
        <button id="preformNextBtn" type="button">‚ñ∂</button>
      </div>
      <div class="preform-actions">
        <button id="preformRotateBtn" type="button">Rotate</button>
      </div>
      <div class="preform-hint">Click a tile to place inside your quadrant.</div>
    </div>
    <div id="leaderboard">
      <h2 style="text-align:center; margin-bottom: 10px;">Leaderboard</h2>
      <!-- Leaderboard entries generati dinamicamente -->
    </div>
    <!-- Nuovi pulsanti in-game -->
    <button id="pauseGameButton">Pause</button>
    <button id="restartGameButton">Restart</button>
  </div>

  <!-- ================== ENDGAME OVERLAY ================== -->
  <div id="endgameOverlay">
    <h1 id="winnerText">Player X Wins!</h1>
    <button id="restartButton">Restart Game</button>
    <button id="downloadLogsBtn" type="button">Download Logs</button>
  </div>

  <!-- ================== DEFEAT OVERLAY ================== -->
  <div id="defeatOverlay" class="overlay-hidden">
    <div class="defeat-card">
      <h1 id="defeatTitle">HAI PERSO</h1>
      <p id="defeatMessage">Il tuo impero √® caduto. La partita continua per gli altri.</p>
      <p id="defeatBestMove" class="defeat-best"></p>
      <button id="closeDefeatBtn">Continua a osservare</button>
    </div>
  </div>
  <!-- ================== PAUSE OVERLAY ================== -->
  <div id="pauseOverlay" class="overlay-hidden">
    <div class="pause-card">
      <h1>Paused</h1>
      <p>Game is frozen. Resume when you're ready.</p>
      <div class="pause-actions">
        <button id="resumeBtn" class="primary">Resume</button>
        <button id="pauseRestartBtn">Restart</button>
        <button id="pauseExitBtn">Exit</button>
        <button id="replayLastMoveBtn" type="button">Replay last move</button>
        <button id="reportTileBtn" type="button">Report broken tile</button>
        <button id="exportLogBtn" type="button">Export debug log</button>
      </div>
    </div>
  </div>
  <div id="reportOverlay" class="overlay-hidden">
    <div class="report-card">
      <h2>Report broken tile</h2>
      <p>Click the tile that is stuck. The board will show coordinates.</p>
      <div id="reportReadout">Hover a tile to see coordinates.</div>
      <div class="report-actions">
        <button id="reportCancelBtn">Cancel</button>
      </div>
    </div>
  </div>
  <div id="boardOverlay" aria-hidden="true">
    <div class="board-overlay-top"></div>
    <div class="board-overlay-left"></div>
    <div class="board-overlay-grid"></div>
  </div>
  <!-- ================== CONFIRM OVERLAY ================== -->
  <div id="confirmOverlay" class="overlay-hidden">
    <div class="confirm-card">
      <h2 id="confirmTitle">Are you sure?</h2>
      <p id="confirmMessage">Are you sure you want to proceed?</p>
      <div class="confirm-actions">
        <button id="confirmYesBtn" class="primary">Yes</button>
        <button id="confirmNoBtn">No</button>
      </div>
    </div>
  </div>
  <div id="newsBox" aria-live="polite" aria-hidden="true">
    <div class="news-header">
      <div class="news-logo">üì∞ <strong>Tiles Wars News</strong></div>
      <button id="newsMinBtn" title="Minimize/Expand" type="button">‚Äì</button>
    </div>
    <div id="newsFeed"></div>
  </div>
  <div id="previewModal" aria-hidden="true">
    <div class="preview-card">
      <div class="preview-header">
        <div>Shrink Animation Preview</div>
        <button id="closePreviewBtn" type="button">‚úï</button>
      </div>
      <div id="previewStage"></div>
    </div>
  </div>

  <!-- Carichiamo lo script alla fine del body, cos√¨ il DOM √® gi√† pronto -->
  <script src="script.js" defer></script>
</body>
</html>
